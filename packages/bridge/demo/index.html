<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bridge Test</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <h1>Bridge Test</h1>
    <strong>推荐打开 DevTools 调试</strong>
    <p>
      测试之前，请确保已经安装好插件，且在文件头添加下面这一句
      <br />
      <code>// @match http://localhost:3000/*</code>
    </p>

    <ol>
      <li>首先获取验证码</li>
      <li>之后输入用户名、密码和验证码，点击登录</li>
      <li>在下方即可展示获得的数据</li>
    </ol>
    <section id="captcha">
      <h2>验证码</h2>
      <div>
        <img alt="captcha" width="100px" />
        <button>获取验证码</button>
      </div>

      <p>验证码 Token： <code></code></p>
    </section>
    <section id="login">
      <h2>登录</h2>

      <input type="text" name="username" placeholder="用户名" />
      <input type="password" name="password" placeholder="密码" />
      <input type="text" name="captcha" placeholder="输入验证码" />

      <button>登录</button>
      <p>登录结果：<code></code></p>
    </section>
    <section id="score">
      <h2>成绩</h2>
      <button>获取成绩</button>
      <table></table>
    </section>

    <script type="module">
      import { Bridge } from './index.js'
      const bridge = new Bridge(window.Fetcher)

      const captcha = {
        image: document.querySelector('#captcha img'),
        button: document.querySelector('#captcha button'),
        token: document.querySelector('#captcha code'),
      }

      let token = ''

      captcha.button.onclick = async () => {
        const res = JSON.parse(await bridge.captcha())
        console.log(res)
        captcha.image.src =
          'data:image/jpeg;charset=utf-8;base64,' + res.img.replace(/\\n/g, '')
        captcha.token.textContent = res.token
        token = res.token
      }

      const login = {
        username: document.querySelector('#login input[name="username"]'),
        password: document.querySelector('#login input[name="password"]'),
        captcha: document.querySelector('#login input[name="captcha"]'),
        button: document.querySelector('#login button'),
        result: document.querySelector('#login code'),
      }

      login.button.onclick = async () => {
        const res = await bridge.login(
          {
            username: login.username.value,
            password: login.password.value,
          },
          { captcha: login.captcha.value, token }
        )
        console.log(res)
        login.result.textContent = res
      }

      const score = {
        button: document.querySelector('#score button'),
        table: document.querySelector('#score table'),
      }

      score.button.onclick = async () => {
        const res = await bridge.score()
        console.log(res)
        const dom = new DOMParser().parseFromString(res, 'text/html')
        score.table.innerHTML = dom.querySelector('#dataList').innerHTML
      }
    </script>
  </body>
</html>
